{% extends 'base.html' %}

{% block title %}Calendario de Citas - Natursur{% endblock %}

{% block content %}
<div id="calendar-data" data-year="{{ a帽o }}" data-month="{{ mes }}" style="display: none;"></div>

<!-- Modal para seleccionar tipo de cita -->
<div id="appointment-modal" class="modal-hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Selecciona el tipo de cita</h3>
            
            <div class="space-y-3 mb-6">
                <button type="button" class="w-full p-3 text-left border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-200 appointment-type-btn" data-type="Masaje">
                    <div class="font-medium text-gray-900"> Masaje</div>
                    <div class="text-sm text-gray-600">Sesi贸n de masaje relajante o terap茅utico</div>
                </button>
                
                <button type="button" class="w-full p-3 text-left border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-200 appointment-type-btn" data-type="Nutrici贸n">
                    <div class="font-medium text-gray-900"> Nutrici贸n</div>
                    <div class="text-sm text-gray-600">Consulta de nutrici贸n personalizada</div>
                </button>
                
                <button type="button" class="w-full p-3 text-left border border-gray-200 rounded-lg hover:bg-gray-50 transition duration-200 appointment-type-btn" data-type="Peso">
                    <div class="font-medium text-gray-900">锔 Control de peso</div>
                    <div class="text-sm text-gray-600">Planificaci贸n y seguimiento de peso</div>
                </button>
            </div>
            
            <div class="flex justify-between space-x-3">
                <button id="cancel-appointment" type="button" class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 text-base font-medium rounded-md hover:bg-gray-400 transition duration-200">
                    Cancelar
                </button>
                <button id="confirm-appointment" type="button" class="flex-1 px-4 py-2 bg-[#00A69A] text-white text-base font-medium rounded-md hover:bg-[#00857A] transition duration-200">
                    Confirmar
                </button>
            </div>
        </div>
    </div>
</div>

<div class="min-h-screen bg-gray-50 pt-4 pb-8">
    <div class="max-w-7xl mx-auto px-4 w-full">
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden min-h-[580px] mt-4">
            <div class="grid grid-cols-1 lg:grid-cols-3 h-full">
                
                <!-- Columna Izquierda - Informaci贸n -->
                <div class="bg-gray-50 p-6 border-r border-gray-200 lg:col-span-1 flex flex-col">
                    <div class="flex-1">
                        <div class="mb-8">
                            <h2 class="text-lg font-bold text-gray-900 mb-2">Fernando Escalona Cuaresma</h2>
                            <div class="w-12 h-1 bg-[#00A69A] mb-4"></div>
                            <h1 class="text-xl font-bold text-gray-900 mb-6">Masaje, Nutrici贸n o Control de Peso</h1>
                        </div>

                        <div class="space-y-4 mb-8">
                            <div class="flex items-center space-x-3 text-gray-700">
                                <svg class="w-4 h-4 text-[#00A69A]" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"/>
                                </svg>
                                <span class="font-medium text-sm">1 hora</span>
                            </div>
                            
                            <div class="flex items-start space-x-3 text-gray-700">
                                <svg class="w-4 h-4 text-[#00A69A] mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                                </svg>
                                <div class="flex-1">
                                    <span class="font-medium text-sm">Avenida Santa Lucia 62</span>
                                    <p class="text-xs text-gray-600 mt-1">Natursur: Masajes y Nutrici贸n</p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg p-4 border border-gray-200 mb-6">
                            <p class="font-semibold text-gray-900 mb-2 text-sm">Confirma tu cita</p>
                            <p class="text-xs text-gray-600">Avisa con 24 horas de antelaci贸n si tienes alg煤n problema</p>
                        </div>
                    </div>

                    <div class="mt-auto pt-6">
                        <div class="text-xs text-blue-600 hover:text-blue-700 transition duration-200 cursor-pointer">
                            Configuraci贸n de cookies
                        </div>
                    </div>
                </div>

                <!-- Columna Derecha - Calendario y Horas -->
                <div class="p-8 lg:col-span-2 flex flex-col">
                    <h2 class="text-2xl font-bold text-gray-900 mb-8">Selecciona fecha y hora</h2>

                    <div class="flex flex-col lg:flex-row gap-4 md:gap-6 h-full">
                        <!-- Calendario -->
                        <div class="w-full lg:w-2/5">
                            <div class="bg-white rounded-xl p-4 h-full flex flex-col">
                                <div class="flex justify-between items-center mb-6 px-2">
                                    <button class="text-[#00A69A] hover:text-[#00857A] p-1 month-nav-btn" data-direction="prev">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                                        </svg>
                                    </button>
                                    
                                    <h4 class="text-lg font-bold text-gray-900" id="mini-calendar-month">{{ nombre_mes_espanol }} {{ a帽o }}</h4>
                                    
                                    <button class="text-[#00A69A] hover:text-[#00857A] p-1 month-nav-btn" data-direction="next">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                                        </svg>
                                    </button>
                                </div>

                                <div class="grid grid-cols-7 gap-1 mb-4 px-2">
                                    <div class="text-center text-xs font-semibold text-gray-500 py-1">L</div>
                                    <div class="text-center text-xs font-semibold text-gray-500 py-1">M</div>
                                    <div class="text-center text-xs font-semibold text-gray-500 py-1">X</div>
                                    <div class="text-center text-xs font-semibold text-gray-500 py-1">J</div>
                                    <div class="text-center text-xs font-semibold text-gray-500 py-1">V</div>
                                    <div class="text-center text-xs font-semibold text-gray-400 py-1">S</div>
                                    <div class="text-center text-xs font-semibold text-gray-400 py-1">D</div>
                                </div>

                                <div class="grid grid-cols-7 gap-1 flex-1 px-2" id="mini-calendar-days"></div>

                                <div class="mt-4 pt-4 border-t border-gray-200">
                                    <div class="text-center">
                                        <div class="text-sm text-gray-600 mb-1">Fecha seleccionada</div>
                                        <div class="font-semibold text-[#00A69A]" id="selected-date-mini-display"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Horas disponibles -->
                        <div class="w-full lg:w-3/5 mt-4 md:mt-0">
                            <div class="bg-white rounded-xl p-6 h-full flex flex-col">
                                <h3 class="text-lg font-bold text-gray-900 mb-4">Horarios disponibles</h3>
                                <div class="mb-4">
                                    <div class="text-sm text-gray-600" id="selected-date-full-display"></div>
                                </div>
                                <div id="hours-container" class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-3"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date();
    const currentDate = {
        year: today.getFullYear(),
        month: today.getMonth() + 1,
        day: today.getDate()
    };
    
    let currentYear = currentDate.year;
    let currentMonth = currentDate.month;
    let selectedDate = `${currentDate.year}-${currentDate.month.toString().padStart(2, '0')}-${currentDate.day.toString().padStart(2, '0')}`;
    let selectedHour = '';
    let selectedType = '';

    const elementos = {
        selectedDateMiniDisplay: document.getElementById('selected-date-mini-display'),
        selectedDateFullDisplay: document.getElementById('selected-date-full-display'),
        hoursContainer: document.getElementById('hours-container'),
        miniCalendarMonth: document.getElementById('mini-calendar-month'),
        monthNavBtns: document.querySelectorAll('.month-nav-btn'),
        miniCalendarDays: document.getElementById('mini-calendar-days'),
        appointmentModal: document.getElementById('appointment-modal'),
        appointmentTypeBtns: document.querySelectorAll('.appointment-type-btn'),
        cancelAppointmentBtn: document.getElementById('cancel-appointment'),
        confirmAppointmentBtn: document.getElementById('confirm-appointment')
    };
    
    const availableHours = ['10:00', '11:00', '12:00', '13:00', '17:00', '18:00', '19:00', '20:00'];
    const mesesEspanol = {
        1: 'Enero', 2: 'Febrero', 3: 'Marzo', 4: 'Abril', 5: 'Mayo', 6: 'Junio',
        7: 'Julio', 8: 'Agosto', 9: 'Septiembre', 10: 'Octubre', 11: 'Noviembre', 12: 'Diciembre'
    };

    function isPastDay(year, month, day) {
        const checkDate = new Date(year, month - 1, day);
        const today = new Date(currentDate.year, currentDate.month - 1, currentDate.day);
        return checkDate < today;
    }

    function isWeekend(year, month, day) {
        const date = new Date(year, month - 1, day);
        return date.getDay() === 0 || date.getDay() === 6;
    }

    function isWithinTwoMonths(year, month) {
        const maxDate = new Date();
        maxDate.setMonth(maxDate.getMonth() + 2);
        const checkDate = new Date(year, month - 1, 1);
        return checkDate <= maxDate;
    }

    function generateMiniCalendarDays(year, month) {
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay();
        
        let daysHTML = '';
        const emptyDays = startingDay === 0 ? 6 : startingDay - 1;
        
        for (let i = 0; i < emptyDays; i++) {
            daysHTML += '<div class="text-center"><div class="py-2 text-transparent text-xs">&nbsp;</div></div>';
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
            const dateString = `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            const isPast = isPastDay(year, month, day);
            const isWeekendDay = isWeekend(year, month, day);
            const isToday = year === currentDate.year && month === currentDate.month && day === currentDate.day;
            const isSelected = dateString === selectedDate;
            
            if (isPast || isWeekendDay) {
                daysHTML += `<div class="text-center"><div class="py-2 text-gray-300 text-xs cursor-not-allowed">${day}</div></div>`;
            } else {
                const btnClass = isToday || isSelected ? 'bg-[#00A69A] text-white' : 'bg-gray-50 text-gray-700 hover:bg-gray-200';
                daysHTML += `
                    <div class="text-center">
                        <button type="button" class="w-full py-2 rounded text-xs transition duration-200 calendar-day-mini-btn ${btnClass}"
                                data-date="${dateString}" data-day="${day}">${day}</button>
                    </div>
                `;
            }
        }
        
        return daysHTML;
    }

    function updateMiniCalendar() {
        elementos.miniCalendarMonth.textContent = `${mesesEspanol[currentMonth]} ${currentYear}`;
        elementos.miniCalendarDays.innerHTML = generateMiniCalendarDays(currentYear, currentMonth);
        
        document.querySelectorAll('.calendar-day-mini-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                selectDate(this.getAttribute('data-date'));
            });
        });
        
        updateNavButtons();
    }

    function updateNavButtons() {
        const prevBtn = document.querySelector('.month-nav-btn[data-direction="prev"]');
        const nextBtn = document.querySelector('.month-nav-btn[data-direction="next"]');
        
        const prevDisabled = currentYear === currentDate.year && currentMonth === currentDate.month;
        const nextDisabled = !isWithinTwoMonths(currentYear, currentMonth + 1);
        
        [prevBtn, nextBtn].forEach((btn, index) => {
            const disabled = index === 0 ? prevDisabled : nextDisabled;
            btn.disabled = disabled;
            btn.classList.toggle('opacity-50 cursor-not-allowed', disabled);
            btn.classList.toggle('hover:text-[#00857A] hover:bg-gray-50', !disabled);
        });
    }

    function selectDate(dateString) {
        selectedDate = dateString;
        updateDateDisplays(dateString);
        highlightSelectedDay(dateString);
        loadAvailableHours(dateString);
    }

    elementos.monthNavBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.disabled) return;
            
            const direction = this.getAttribute('data-direction');
            let newMonth = currentMonth;
            let newYear = currentYear;
            
            if (direction === 'prev') {
                newMonth--;
                if (newMonth < 1) {
                    newMonth = 12;
                    newYear--;
                }
                if (newYear < currentDate.year || (newYear === currentDate.year && newMonth < currentDate.month)) return;
            } else {
                if (!isWithinTwoMonths(currentYear, currentMonth + 1)) return;
                newMonth++;
                if (newMonth > 12) {
                    newMonth = 1;
                    newYear++;
                }
            }
            
            currentMonth = newMonth;
            currentYear = newYear;
            updateMiniCalendar();
        });
    });

    function updateDateDisplays(dateString) {
        const dateObj = new Date(dateString);
        const day = dateObj.getDate();
        const month = mesesEspanol[dateObj.getMonth() + 1];
        const year = dateObj.getFullYear();
        
        elementos.selectedDateMiniDisplay.textContent = `${day} de ${month}`;
        elementos.selectedDateFullDisplay.textContent = `${day} de ${month} de ${year}`;
    }

    function highlightSelectedDay(dateString) {
        document.querySelectorAll('.calendar-day-mini-btn').forEach(btn => {
            const btnDate = btn.getAttribute('data-date');
            const dateObj = new Date(btnDate);
            const year = dateObj.getFullYear();
            const month = dateObj.getMonth() + 1;
            const day = dateObj.getDate();
            const isToday = year === currentDate.year && month === currentDate.month && day === currentDate.day;
            
            if (btnDate === dateString) {
                btn.classList.add('bg-[#00A69A]', 'text-white');
                btn.classList.remove('bg-gray-50', 'text-gray-700');
            } else if (isToday) {
                btn.classList.add('bg-[#00A69A]', 'text-white');
            } else {
                btn.classList.remove('bg-[#00A69A]', 'text-white');
                btn.classList.add('bg-gray-50', 'text-gray-700');
            }
        });
    }

    function loadAvailableHours(dateString) {
        elementos.hoursContainer.innerHTML = '';
        
        fetch(`/calendario/horas-ocupadas/?fecha=${dateString}`)
            .then(response => response.json())
            .then(horasOcupadas => {
                const dateObj = new Date(dateString);
                const year = dateObj.getFullYear();
                const month = dateObj.getMonth() + 1;
                const day = dateObj.getDate();
                const isWeekendDay = isWeekend(year, month, day);
                
                if (!isWeekendDay) {
                    availableHours.forEach(hour => {
                        const isOcupada = horasOcupadas.includes(hour);
                        const hourCard = document.createElement('button');
                        
                        if (isOcupada) {
                            hourCard.className = 'bg-gray-50 text-gray-300 rounded-lg p-4 text-center border border-gray-200 flex flex-col items-center justify-center cursor-not-allowed opacity-40';
                            hourCard.disabled = true;
                            hourCard.innerHTML = `
                                <div class="font-medium text-gray-400 text-sm">${hour}</div>
                                <div class="text-xs text-gray-400 mt-1">Ocupada</div>
                            `;
                        } else {
                            hourCard.className = 'bg-gray-50 hover:bg-[#00A69A] hover:text-white rounded-lg p-4 text-center transition duration-200 border border-gray-200 flex flex-col items-center justify-center';
                            hourCard.innerHTML = `
                                <div class="font-medium text-gray-700 text-sm">${hour}</div>
                                <div class="text-xs text-gray-500 mt-1">Disponible</div>
                            `;
                            
                            hourCard.addEventListener('click', function() {
                                selectedHour = hour;
                                showAppointmentTypeModal();
                            });
                        }
                        
                        elementos.hoursContainer.appendChild(hourCard);
                    });
                }
            })
            .catch(error => {
                console.error('Error cargando horas:', error);
                elementos.hoursContainer.innerHTML = '<div class="text-red-500">Error cargando horarios</div>';
            });
    }

    function showAppointmentTypeModal() {
        selectedType = '';
        elementos.appointmentTypeBtns.forEach(btn => {
            btn.classList.remove('bg-[#00A69A]', 'text-white', 'border-[#00A69A]');
            btn.classList.add('border-gray-200', 'hover:bg-gray-50');
        });
        elementos.appointmentModal.classList.remove('modal-hidden');
    }

    function hideAppointmentTypeModal() {
        elementos.appointmentModal.classList.add('modal-hidden');
    }

    function createAppointment() {
        if (!selectedType) {
            alert('Por favor selecciona un tipo de cita');
            return;
        }
        
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{% url 'crear_cita_final' %}";
        
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);
        
        const addHiddenInput = (name, value) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            form.appendChild(input);
        };
        
        addHiddenInput('fecha', selectedDate);
        addHiddenInput('hora', selectedHour);
        addHiddenInput('tipo', selectedType);
        
        document.body.appendChild(form);
        form.submit();
        hideAppointmentTypeModal();
    }

    elementos.appointmentTypeBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            elementos.appointmentTypeBtns.forEach(b => {
                b.classList.remove('bg-[#00A69A]', 'text-white', 'border-[#00A69A]');
                b.classList.add('border-gray-200', 'hover:bg-gray-50');
            });
            
            this.classList.remove('border-gray-200', 'hover:bg-gray-50');
            this.classList.add('bg-[#00A69A]', 'text-white', 'border-[#00A69A]');
            selectedType = this.getAttribute('data-type');
        });
    });

    elementos.cancelAppointmentBtn.addEventListener('click', hideAppointmentTypeModal);
    elementos.confirmAppointmentBtn.addEventListener('click', createAppointment);

    elementos.appointmentModal.addEventListener('click', function(e) {
        if (e.target === elementos.appointmentModal) hideAppointmentTypeModal();
    });

    function initialize() {
        updateMiniCalendar();
        selectDate(selectedDate);
    }

    initialize();
});
</script>


<style>
.modal-hidden {
    display: none !important;
}

@media (max-width: 768px) {
    .calendar-day-mini-btn {
        min-height: 50px !important;
    }
    
    #hours-container button {
        min-height: 70px !important;
    }
}
</style>
{% endblock %}